<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMIN - Cyber Escape Game</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
</head>
<body class="admin-mode">
    <div class="admin-container">
        <header class="admin-header">
            <h1>üéÆ CYBER ESCAPE GAME - CONTR√îLE MISSION</h1>
            <div class="admin-controls">
                <div class="global-timer">
                    ‚è∞ Temps global: <span id="globalTimer">30:00</span>
                </div>
                <div class="control-buttons">
                    <button onclick="pauseAllGames()" class="btn-pause">‚è∏Ô∏è PAUSE G√âN√âRALE</button>
                    <button onclick="resumeAllGames()" class="btn-resume">‚ñ∂Ô∏è REPRENDRE</button>
                    <button onclick="resetAllGames()" class="btn-reset">üîÑ RESET COMPLET</button>
                </div>
            </div>
        </header>

        <main class="admin-main">
            <div class="teams-grid" id="teamsGrid">
                <!-- Les √©quipes seront inject√©es dynamiquement -->
            </div>

            <div class="admin-sidebar">
                <div class="quick-actions">
                    <h3>‚ö° Actions Rapides</h3>
                    <button onclick="broadcastMessage()" class="quick-btn">üì¢ MESSAGE GLOBAL</button>
                    <button onclick="giveHintAll()" class="quick-btn">üí° INDICE G√âN√âRAL</button>
                    <button onclick="showLeaderboard()" class="quick-btn">üèÜ CLASSEMENT</button>
                    <button onclick="exportResults()" class="quick-btn">üìä EXPORT R√âSULTATS</button>
                </div>

                <div class="game-stats">
                    <h3>üìà Statistiques</h3>
                    <div class="stat-item">
                        <span>√âquipes actives:</span>
                        <span id="activeTeams">0</span>
                    </div>
                    <div class="stat-item">
                        <span>√ânigmes r√©solues:</span>
                        <span id="totalSolved">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Temps moyen:</span>
                        <span id="averageTime">--:--</span>
                    </div>
                </div>

                <div class="announcements">
                    <h3>üìã Annonces Programm√©es</h3>
                    <div class="announcement-list">
                        <div class="announcement-item">
                            <span>5 min: "Hackers d√©tectent votre intervention !"</span>
                            <button onclick="triggerAnnouncement(1)">üì¢</button>
                        </div>
                        <div class="announcement-item">
                            <span>15 min: "50% des syst√®mes compromis !"</span>
                            <button onclick="triggerAnnouncement(2)">üì¢</button>
                        </div>
                        <div class="announcement-item">
                            <span>25 min: "Plus que 5 minutes !"</span>
                            <button onclick="triggerAnnouncement(3)">üì¢</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Modal pour messages -->
        <div id="messageModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal()">&times;</span>
                <h3>üì¢ Message Global</h3>
                <textarea id="broadcastText" placeholder="Tapez votre message..."></textarea>
                <div class="modal-buttons">
                    <button onclick="sendBroadcast()" class="btn-send">Envoyer</button>
                    <button onclick="closeModal()" class="btn-cancel">Annuler</button>
                </div>
            </div>
        </div>

        <!-- Modal Leaderboard -->
        <div id="leaderboardModal" class="modal">
            <div class="modal-content large">
                <span class="close" onclick="closeModal()">&times;</span>
                <h3>üèÜ Classement en Temps R√©el</h3>
                <div id="leaderboardContent"></div>
            </div>
        </div>
    </div>

    <script src="js/admin.js"></script>
    <script>
        // Donn√©es des √©quipes (simulation)
        let teamsData = [
            {id: 'TEAM01', name: 'Cyber Warriors', progress: 0, currentEnigma: 1, time: 0, attempts: 0, hints: 0, status: 'active'},
            {id: 'TEAM02', name: 'Digital Guardians', progress: 0, currentEnigma: 1, time: 0, attempts: 0, hints: 0, status: 'active'},
            {id: 'TEAM03', name: 'Security Squad', progress: 0, currentEnigma: 1, time: 0, attempts: 0, hints: 0, status: 'active'},
            {id: 'TEAM04', name: 'Code Breakers', progress: 0, currentEnigma: 1, time: 0, attempts: 0, hints: 0, status: 'active'},
            {id: 'TEAM05', name: 'Byte Force', progress: 0, currentEnigma: 1, time: 0, attempts: 0, hints: 0, status: 'active'},
            {id: 'TEAM06', name: 'Firewall Fighters', progress: 0, currentEnigma: 1, time: 0, attempts: 0, hints: 0, status: 'active'},
        ];

        let gameStarted = false;
        let globalTime = 30 * 60; // 30 minutes

        // Initialisation
        window.onload = function() {
            renderTeams();
            startGlobalTimer();
            simulateTeamProgress(); // Simulation pour d√©mo
        };

        function renderTeams() {
            const grid = document.getElementById('teamsGrid');
            grid.innerHTML = '';

            teamsData.forEach(team => {
                const progressPercent = (team.progress / 6) * 100;
                const statusClass = team.status === 'completed' ? 'completed' : team.status === 'paused' ? 'paused' : 'active';
                
                const teamCard = `
                    <div class="team-card ${statusClass}">
                        <div class="team-header">
                            <h4>${team.name}</h4>
                            <span class="team-id">${team.id}</span>
                        </div>
                        
                        <div class="team-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progressPercent}%"></div>
                            </div>
                            <div class="progress-info">
                                <span>√ânigmes: ${team.progress}/6</span>
                                <span>Temps: ${formatTime(team.time)}</span>
                            </div>
                        </div>

                        <div class="team-details">
                            <div class="detail-item">
                                <span>√ânigme actuelle:</span>
                                <span class="current-enigma">${team.currentEnigma}</span>
                            </div>
                            <div class="detail-item">
                                <span>Tentatives:</span>
                                <span>${team.attempts}</span>
                            </div>
                            <div class="detail-item">
                                <span>Indices utilis√©s:</span>
                                <span>${team.hints}</span>
                            </div>
                        </div>

                        <div class="team-actions">
                            <button onclick="giveHint('${team.id}')" class="btn-hint">üí° Indice</button>
                            <button onclick="viewTeam('${team.id}')" class="btn-view">üëÅÔ∏è Observer</button>
                            <button onclick="pauseTeam('${team.id}')" class="btn-pause-team">‚è∏Ô∏è</button>
                        </div>
                    </div>
                `;
                
                grid.innerHTML += teamCard;
            });

            updateStats();
        }

        function startGlobalTimer() {
            const timerElement = document.getElementById('globalTimer');
            
            const timer = setInterval(() => {
                if (globalTime <= 0) {
                    clearInterval(timer);
                    endGame();
                    return;
                }
                
                globalTime--;
                timerElement.textContent = formatTime(globalTime);
                
                // Mise √† jour du temps pour chaque √©quipe
                teamsData.forEach(team => {
                    if (team.status === 'active') {
                        team.time++;
                    }
                });
                
                // D√©clenchement d'annonces automatiques
                checkAutoAnnouncements();
                
                // Mise √† jour de l'affichage
                renderTeams();
                
            }, 1000);
        }

        function checkAutoAnnouncements() {
            const remaining = globalTime;
            
            if (remaining === 25 * 60) {
                triggerAnnouncement(1);
            } else if (remaining === 15 * 60) {
                triggerAnnouncement(2);
            } else if (remaining === 5 * 60) {
                triggerAnnouncement(3);
            }
        }

        function simulateTeamProgress() {
            // Simulation de progression d'√©quipes pour la d√©mo
            setInterval(() => {
                if (Math.random() > 0.7) { // 30% de chance
                    const randomTeam = teamsData[Math.floor(Math.random() * teamsData.length)];
                    if (randomTeam.status === 'active' && randomTeam.progress < 6) {
                        if (Math.random() > 0.5) {
                            randomTeam.progress++;
                            randomTeam.currentEnigma = Math.min(randomTeam.currentEnigma + 1, 6);
                        } else {
                            randomTeam.attempts++;
                        }
                    }
                }
            }, 5000);
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function updateStats() {
            const activeCount = teamsData.filter(team => team.status === 'active').length;
            const totalSolved = teamsData.reduce((sum, team) => sum + team.progress, 0);
            const avgTime = teamsData.reduce((sum, team) => sum + team.time, 0) / teamsData.length;

            document.getElementById('activeTeams').textContent = activeCount;
            document.getElementById('totalSolved').textContent = totalSolved;
            document.getElementById('averageTime').textContent = formatTime(Math.floor(avgTime));
        }

        // Actions d'administration
        function pauseAllGames() {
            teamsData.forEach(team => {
                if (team.status === 'active') team.status = 'paused';
            });
            renderTeams();
            broadcastSystemMessage("‚è∏Ô∏è PAUSE G√âN√âRALE - Attendez les instructions");
        }

        function resumeAllGames() {
            teamsData.forEach(team => {
                if (team.status === 'paused') team.status = 'active';
            });
            renderTeams();
            broadcastSystemMessage("‚ñ∂Ô∏è REPRISE DU JEU - Continuez votre mission !");
        }

        function giveHint(teamId) {
            const team = teamsData.find(t => t.id === teamId);
            if (team) {
                team.hints++;
                const hint = getHintForEnigma(team.currentEnigma);
                // Dans une vraie impl√©mentation, on enverrait l'indice √† l'√©quipe
                alert(`Indice envoy√© √† ${teamId}: ${hint}`);
                renderTeams();
            }
        }

        function getHintForEnigma(enigmaNumber) {
            const hints = {
                1: "Pensez √† l'alphabet et aux chiffres... A=1, B=2...",
                2: "Regardez attentivement les domaines et les URLs",
                3: "Superposez les √©l√©ments pour reconstituer l'image",
                4: "M√©fiez-vous des noms trop similaires aux vrais r√©seaux",
                5: "Les informations personnelles sont souvent utilis√©es dans les mots de passe",
                6: "Additionnez tous les chiffres que vous avez trouv√©s"
            };
            return hints[enigmaNumber] || "Continuez √† chercher !";
        }

        function broadcastMessage() {
            document.getElementById('messageModal').style.display = 'block';
        }

        function sendBroadcast() {
            const message = document.getElementById('broadcastText').value;
            if (message.trim()) {
                broadcastSystemMessage(message);
                closeModal();
                document.getElementById('broadcastText').value = '';
            }
        }

        function broadcastSystemMessage(message) {
            // Dans une vraie impl√©mentation, ceci enverrait le message √† toutes les √©quipes
            console.log('Broadcast:', message);
            
            // Simulation d'affichage du message
            const notification = document.createElement('div');
            notification.className = 'broadcast-notification';
            notification.textContent = `üì¢ ${message}`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        function triggerAnnouncement(announcementId) {
            const announcements = {
                1: "üö® Les hackers ont d√©tect√© votre intervention ! Ils acc√©l√®rent leur attaque !",
                2: "‚ö†Ô∏è ALERTE CRITIQUE ! 50% des syst√®mes sont maintenant compromis !",
                3: "üî• DERNI√àRE LIGNE DROITE ! Plus que 5 minutes pour sauver l'universit√© !"
            };
            
            broadcastSystemMessage(announcements[announcementId]);
        }

        function showLeaderboard() {
            const sortedTeams = [...teamsData].sort((a, b) => {
                if (a.progress !== b.progress) return b.progress - a.progress;
                return a.time - b.time;
            });

            let leaderboardHTML = '<div class="leaderboard">';
            sortedTeams.forEach((team, index) => {
                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}.`;
                leaderboardHTML += `
                    <div class="leaderboard-item">
                        <span class="rank">${medal}</span>
                        <span class="team-name">${team.name}</span>
                        <span class="team-progress">${team.progress}/6</span>
                        <span class="team-time">${formatTime(team.time)}</span>
                    </div>
                `;
            });
            leaderboardHTML += '</div>';

            document.getElementById('leaderboardContent').innerHTML = leaderboardHTML;
            document.getElementById('leaderboardModal').style.display = 'block';
        }

        function exportResults() {
            const results = teamsData.map(team => ({
                √âquipe: team.name,
                ID: team.id,
                √ânigmes: team.progress,
                Temps: formatTime(team.time),
                Tentatives: team.attempts,
                Indices: team.hints,
                Statut: team.status
            }));

            const csv = [
                Object.keys(results[0]).join(','),
                ...results.map(row => Object.values(row).join(','))
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cyber-escape-results-${new Date().toISOString().slice(0, 10)}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function closeModal() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
        }

        function viewTeam(teamId) {
            // Ouvrir la vue de l'√©quipe dans un nouvel onglet
            window.open(`game.html?team=${teamId}&admin=1`, '_blank');
        }

        function pauseTeam(teamId) {
            const team = teamsData.find(t => t.id === teamId);
            if (team) {
                team.status = team.status === 'active' ? 'paused' : 'active';
                renderTeams();
            }
        }

        function resetAllGames() {
            if (confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir r√©initialiser TOUS les jeux ?')) {
                teamsData.forEach(team => {
                    team.progress = 0;
                    team.currentEnigma = 1;
                    team.time = 0;
                    team.attempts = 0;
                    team.hints = 0;
                    team.status = 'active';
                });
                globalTime = 30 * 60;
                renderTeams();
                broadcastSystemMessage('üîÑ RESET COMPLET - Tous les jeux ont √©t√© r√©initialis√©s');
            }
        }

        function endGame() {
            teamsData.forEach(team => {
                team.status = 'completed';
            });
            renderTeams();
            broadcastSystemMessage('‚è∞ TEMPS √âCOUL√â ! Mission termin√©e.');
            showLeaderboard();
        }
    </script>
</body>
</html>
