<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CYBER ESCAPE GAME - En cours</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
</head>
<body class="game-mode">
    <!-- Header de progression -->
    <div class="game-header">
        <div class="team-info">
            <span id="teamDisplay">TEAM01</span>
            <div class="timer-display">
                ‚è∞ <span id="gameTimer">30:00</span>
            </div>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            <div class="progress-text">√ânigmes: <span id="progressText">0/6</span></div>
        </div>
    </div>

    <!-- Zone de notification -->
    <div id="notification" class="notification hidden"></div>

    <!-- Contenu principal des √©nigmes -->
    <div class="game-container" id="gameContainer">
        <!-- Le contenu sera inject√© dynamiquement par JavaScript -->
    </div>

    <!-- Modal d'aide -->
    <div id="helpModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeHelp()">&times;</span>
            <h3>üí° Besoin d'aide ?</h3>
            <div id="helpContent"></div>
            <button onclick="useHint()" class="hint-btn">Utiliser un indice (üÉè Joker)</button>
        </div>
    </div>

    <!-- √âcran de victoire -->
    <div id="victoryScreen" class="victory-screen hidden">
        <div class="victory-content">
            <h1 class="victory-title">üéä MISSION ACCOMPLIE ! üéä</h1>
            <div class="victory-animation">
                <div class="pulse-circle"></div>
            </div>
            <div class="victory-stats">
                <h2>‚è±Ô∏è Temps final: <span id="finalTime"></span></h2>
                <h3>üèÜ √âquipe: <span id="victoryTeam"></span></h3>
                <div class="victory-achievements">
                    <div class="achievement">‚úÖ Syst√®mes restaur√©s: 100%</div>
                    <div class="achievement">üõ°Ô∏è Donn√©es prot√©g√©es: 15,000 profils</div>
                    <div class="achievement">üéñÔ∏è Grade obtenu: <span id="finalGrade">CYBER-H√âROS</span></div>
                </div>
            </div>
            <div class="victory-actions">
                <button onclick="generateCertificate()" class="victory-btn">üìú CERTIFICAT</button>
                <button onclick="shareResult()" class="victory-btn">üì§ PARTAGER</button>
                <button onclick="restartGame()" class="victory-btn">üîÑ RECOMMENCER</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/game.js"></script>
    <script src="js/enigmes.js"></script>
    <script src="js/timer.js"></script>
    
    <script>
        // Initialisation du jeu
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const teamCode = urlParams.get('team') || localStorage.getItem('currentTeam') || 'TEAM01';
            
            // Affichage du code √©quipe
            document.getElementById('teamDisplay').textContent = teamCode;
            
            // Initialisation du jeu
            Game.init(teamCode);
            Timer.start(30); // 30 minutes
            
            // Chargement de la premi√®re √©nigme
            loadEnigma(1);
        };
        
        // Gestion des notifications
        function showNotification(message, type = 'info', duration = 3000) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.remove('hidden');
            
            setTimeout(() => {
                notification.classList.add('hidden');
            }, duration);
        }
        
        // Navigation entre √©nigmes
        function nextEnigma() {
            const currentEnigma = Game.getCurrentEnigma();
            if (currentEnigma < 6) {
                loadEnigma(currentEnigma + 1);
            } else {
                showVictory();
            }
        }
        
        // Chargement d'une √©nigme
        function loadEnigma(enigmaNumber) {
            const container = document.getElementById('gameContainer');
            const enigma = Enigmas.getEnigma(enigmaNumber);
            
            container.innerHTML = enigma.render();
            Game.setCurrentEnigma(enigmaNumber);
            updateProgress();
            
            // Animation d'entr√©e
            container.style.opacity = '0';
            setTimeout(() => {
                container.style.opacity = '1';
            }, 100);
        }
        
        // Mise √† jour de la progression
        function updateProgress() {
            const current = Game.getCurrentEnigma();
            const total = 6;
            const percentage = ((current - 1) / total) * 100;
            
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = `${current - 1}/${total}`;
        }
        
        // Validation des r√©ponses
        function validateAnswer(enigmaId, answer) {
            const correct = Enigmas.checkAnswer(enigmaId, answer);
            
            if (correct) {
                showNotification('‚úÖ √ânigme r√©solue ! Code obtenu.', 'success');
                Game.solveEnigma(enigmaId);
                
                setTimeout(() => {
                    nextEnigma();
                }, 1500);
                
                return true;
            } else {
                showNotification('‚ùå Code incorrect ! R√©essayez...', 'error');
                Game.addAttempt();
                return false;
            }
        }
        
        // Affichage de la victoire
        function showVictory() {
            const finalTime = Timer.stop();
            const teamCode = Game.getTeam();
            const grade = calculateGrade();
            
            document.getElementById('finalTime').textContent = finalTime;
            document.getElementById('victoryTeam').textContent = teamCode;
            document.getElementById('finalGrade').textContent = grade;
            
            document.getElementById('victoryScreen').classList.remove('hidden');
            
            // Confetti
            if (typeof confetti !== 'undefined') {
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });
            }
        }
        
        function calculateGrade() {
            const time = Game.getTotalTime();
            const attempts = Game.getTotalAttempts();
            
            if (time < 20 * 60 && attempts < 10) return 'CYBER-EXPERT';
            if (time < 25 * 60 && attempts < 15) return 'DIGITAL-GUARDIAN';
            if (time < 30 * 60) return 'SECURITY-ROOKIE';
            return 'FUTURE-HACKER';
        }
        
        // Actions de victoire
        function generateCertificate() {
            const team = Game.getTeam();
            const time = Game.getTotalTime();
            const grade = calculateGrade();
            
            const certificate = `
                üèÜ CERTIFICAT DE CYBERS√âCURIT√â üèÜ
                
                √âquipe: ${team}
                Grade: ${grade}
                Temps: ${Timer.formatTime(time)}
                Date: ${new Date().toLocaleDateString()}
                
                Cette √©quipe a brillamment neutralis√©
                une cyberattaque et sauv√© l'universit√© !
                
                #CyberEscapeGame #Cybers√©curit√©
            `;
            
            navigator.clipboard.writeText(certificate).then(() => {
                showNotification('üìã Certificat copi√© dans le presse-papiers !', 'success');
            });
        }
        
        function shareResult() {
            const text = `üéÆ Je viens de terminer le Cyber Escape Game en ${Timer.formatTime(Game.getTotalTime())} ! Grade obtenu: ${calculateGrade()} üèÜ #CyberEscapeGame`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Cyber Escape Game',
                    text: text,
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(text);
                showNotification('üì§ R√©sultat copi√© ! Partagez-le sur vos r√©seaux sociaux.', 'success');
            }
        }
        
        function restartGame() {
            if (confirm('√ätes-vous s√ªr de vouloir recommencer ?')) {
                localStorage.removeItem('gameProgress');
                location.reload();
            }
        }
    </script>
</body>
</html>